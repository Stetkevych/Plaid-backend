import { Configuration, PlaidApi, PlaidEnvironments } from "plaid";
import nodemailer from "nodemailer";

const plaid = new PlaidApi(
  new Configuration({
    basePath: PlaidEnvironments.production,
    baseOptions: {
      headers: {
        "PLAID-CLIENT-ID": process.env.PLAID_CLIENT_ID,
        "PLAID-SECRET": process.env.PLAID_SECRET
      }
    }
  })
);

export default async function handler(req, res) {
  // Allow browser calls
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  // GET = create link token
  if (req.method === "GET") {
    const link = await plaid.linkTokenCreate({
      user: { client_user_id: "sales-client" },
      client_name: "Sales Pipeline",
      products: ["assets"],
      country_codes: ["US"],
      language: "en"
    });

    return res.json({ link_token: link.data.link_token });
  }

  // POST = exchange token, pull data, email it
  const { public_token } = req.body;

  const exchange = await plaid.itemPublicTokenExchange({
    public_token
  });

  const access_token = exchange.data.access_token;

  const report = await plaid.assetReportCreate({
    access_tokens: [access_token],
    days_requested: 60
  });

  // Send email
  const transporter = nodemailer.createTransport({
    host: process.env.EMAIL_HOST,
    port: 587,
    secure: false,
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS
    }
  });

  await transporter.sendMail({
    to: process.env.RECEIVE_EMAIL,
    subject: "Client Bank Statements",
    text: JSON.stringify(report.data, null, 2)
  });

  res.status(200).json({ success: true });
}
