<script>
  const button = document.getElementById("link-button");
  const originalText = button.textContent;

  function fail(msg) {
    button.disabled = true;
    button.textContent = msg || "Unable to initialize";
  }

  async function createLinkToken() {
    const res = await fetch("/api/create_link_token", { method: "POST" });
    const text = await res.text();

    if (!res.ok) throw new Error(text || "create_link_token failed");

    const data = JSON.parse(text);
    if (!data.link_token) throw new Error("No link_token returned");

    return data.link_token;
  }

  async function initPlaid() {
    try {
      if (!window.Plaid) throw new Error("Plaid SDK not loaded");

      const linkToken = await createLinkToken();

      const handler = Plaid.create({
        token: linkToken,
        onSuccess: (public_token) => {
          console.log("Success public_token:", public_token);
          alert("Connected (success callback fired). Next: exchange_token + store.");
        },
        onExit: (err) => {
          if (err) console.error(err);
        },
      });

      button.disabled = false;
      button.textContent = originalText || "Connect Bank Securely";
      button.addEventListener("click", () => handler.open());
    } catch (e) {
      console.error(e);
      fail("Backend not ready");
    }
  }

  // Start
  button.disabled = true;
  button.textContent = "Initializingâ€¦";
  initPlaid();
</script>
